<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出站管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .status {
            font-size: 18px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        .socks-settings, .wireguard-settings {
            display: none;
            margin-top: 20px;
        }
        .mode-select {
            margin-top: 20px;
            font-size: 16px;
        }
        .error {
            color: red;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <h1>出站管理</h1>

    <div class="status">当前出站状态: <span id="status">加载中...</span></div>

    <!-- 模式选择下拉框 -->
    <div class="mode-select">
        <label for="mode-select">选择出站模式: </label>
        <select id="mode-select" onchange="showModeSettings(this.value)">
            <option value="none">请选择模式</option>
            <option value="wireguard">WireGuard</option>
            <option value="socks">Socks</option>
            <option value="disable">关闭出站</option>
        </select>
    </div>

    <!-- WireGuard 配置设置 -->
    <div class="wireguard-settings" id="wireguard-settings">
        <h3>WireGuard 配置</h3>
        <button onclick="setWireGuard()">确认设置 WireGuard</button>
    </div>

    <!-- Socks 配置设置 -->
    <div class="socks-settings" id="socks-settings">
        <h3>Socks 配置</h3>
        <input type="text" id="server" placeholder="服务器地址 (IPv4 格式)">
        <input type="number" id="server_port" placeholder="端口 (范围: 1-65535)" min="1" max="65535">
        <input type="text" id="username" placeholder="用户名">
        <input type="password" id="password" placeholder="密码">
        <button onclick="setSocks()">确认设置 Socks</button>
        <div class="error" id="socks-error"></div>
    </div>

    <script>
        // 获取当前出站状态
        async function getOutboundStatus() {
            try {
                let res = await fetch("/getOutboundStatus");
                let data = await res.json();
                document.getElementById("status").textContent = data.status;
            } catch (err) {
                document.getElementById("status").textContent = "无法获取状态";
            }
        }

        // 切换模式并显示相应配置
        function showModeSettings(mode) {
            // 隐藏所有设置
            document.getElementById("wireguard-settings").style.display = 'none';
            document.getElementById("socks-settings").style.display = 'none';

            // 根据选择的模式显示相应的设置
            if (mode === 'wireguard') {
                document.getElementById("wireguard-settings").style.display = 'block';
            } else if (mode === 'socks') {
                document.getElementById("socks-settings").style.display = 'block';
            } else if (mode === 'disable') {
                disableOutbound();
            }
        }

        // 设置 WireGuard 出站
        async function setWireGuard() {
            await fetch("/setWireGuard", { method: "POST" });
            alert("WireGuard 出站已设置");
            getOutboundStatus();
        }

        // 设置 Socks 出站
        async function setSocks() {
            let server = document.getElementById("server").value;
            let server_port = document.getElementById("server_port").value;
            let username = document.getElementById("username").value;
            let password = document.getElementById("password").value;
            let errorDiv = document.getElementById("socks-error");
            errorDiv.textContent = "";  // 清空错误信息

            // 正则验证 IP 格式 (IPv4)
            let ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!server || !server.match(ipRegex)) {
                errorDiv.textContent = "服务器地址必须是有效的 IPv4 地址。";
                return;
            }

            // 验证端口范围
            if (server_port < 1 || server_port > 65535) {
                errorDiv.textContent = "端口必须在 1 到 65535 之间。";
                return;
            }

            if (!username || !password) {
                alert("请填写完整的 Socks 配置");
                return;
            }

            await fetch("/setSocks", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ server, server_port, username, password })
            });

            alert("Socks 出站已设置");
            getOutboundStatus();
        }

        // 关闭所有出站
        async function disableOutbound() {
            await fetch("/disableOutbound", { method: "POST" });
            alert("出站已关闭");
            getOutboundStatus();
        }

        // 页面加载时获取出站状态
        getOutboundStatus();
    </script>

</body>
</html>